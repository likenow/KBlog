<!DOCTYPE html>




<html class="theme-next gemini" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="kvc,">










<meta name="description" content="KVC KVC（Key-value coding）键值编码，是指iOS的开发中，可以允许开发者通过Key名直接访问对象的属性，或者给对象的属性赋值。而不需要调用明确的存取方法。这样就可以在运行时动态地访问和修改对象的属性。">
<meta name="keywords" content="kvc">
<meta property="og:type" content="article">
<meta property="og:title" content="KVC 的使用">
<meta property="og:url" content="http://yoursite.com/2016/04/23/2016-4-23-KVC的使用/index.html">
<meta property="og:site_name" content="Karl&#39;s Blog">
<meta property="og:description" content="KVC KVC（Key-value coding）键值编码，是指iOS的开发中，可以允许开发者通过Key名直接访问对象的属性，或者给对象的属性赋值。而不需要调用明确的存取方法。这样就可以在运行时动态地访问和修改对象的属性。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-11-18T14:15:28.783Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="KVC 的使用">
<meta name="twitter:description" content="KVC KVC（Key-value coding）键值编码，是指iOS的开发中，可以允许开发者通过Key名直接访问对象的属性，或者给对象的属性赋值。而不需要调用明确的存取方法。这样就可以在运行时动态地访问和修改对象的属性。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2016/04/23/2016-4-23-KVC的使用/">





  <title>KVC 的使用 | Karl's Blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?d714d594e46d4e86189e49fe568d871a";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Karl's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/04/23/2016-4-23-KVC的使用/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="karl">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Karl's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">KVC 的使用</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-04-23T17:52:43+08:00">
                2016-04-23
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="KVC"><a href="#KVC" class="headerlink" title="KVC"></a>KVC</h2><blockquote>
<p>KVC（Key-value coding）键值编码，是指iOS的开发中，可以允许开发者通过Key名直接访问对象的属性，或者给对象的属性赋值。而不需要调用明确的存取方法。这样就可以在运行时动态地访问和修改对象的属性。</p>
</blockquote>
<a id="more"></a>
<h2 id="理解-KVC"><a href="#理解-KVC" class="headerlink" title="理解 KVC"></a>理解 KVC</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (nullable id)valueForKey:(NSString *)key;                          //直接通过Key来取值</span><br><span class="line">- (void)setValue:(nullable id)value forKey:(NSString *)key;          //通过Key来设值</span><br><span class="line">- (nullable id)valueForKeyPath:(NSString *)keyPath;                  //通过KeyPath来取值</span><br><span class="line">- (void)setValue:(nullable id)value forKeyPath:(NSString *)keyPath;  //通过KeyPath来设值</span><br></pre></td></tr></table></figure>
<p>以上代码来自<code>Foundation/NSKeyValueCoding.h</code>。</p>
<h3 id="赋值"><a href="#赋值" class="headerlink" title="赋值"></a>赋值</h3><blockquote>
<p>The default implementation of this method does the following:</p>
<ol>
<li><p>Searches the class of the receiver for an accessor method whose name matches the pattern -set<key>:. If such a method is found the type of its parameter is checked. If the parameter type is not an object pointer type but the value is nil -setNilValueForKey: is invoked. The default implementation of -setNilValueForKey: raises an NSInvalidArgumentException, but you can override it in your application. Otherwise, if the type of the method’s parameter is an object pointer type the method is simply invoked with the value as the argument. If the type of the method’s parameter is some other type the inverse of the NSNumber/NSValue conversion done by -valueForKey: is performed before the method is invoked.</key></p>
</li>
<li><p>Otherwise (no accessor method is found), if the receiver’s class’ +accessInstanceVariablesDirectly property returns YES, searches the class of the receiver for an instance variable whose name matches the pattern _<key>, _is<key>, <key>, or is<key>, in that order. If such an instance variable is found and its type is an object pointer type the value is retained and the result is set in the instance variable, after the instance variable’s old value is first released. If the instance variable’s type is some other type its value is set after the same sort of conversion from NSNumber or NSValue as in step 1.</key></key></key></key></p>
</li>
<li><p>Otherwise (no accessor method or instance variable is found), invokes -setValue:forUndefinedKey:. The default implementation of -setValue:forUndefinedKey: raises an NSUndefinedKeyException, but you can override it in your application.</p>
</li>
</ol>
</blockquote>
<p>下面，我们要引入一段代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;ViewController.h&quot;</span><br><span class="line">#import &quot;Car.h&quot;</span><br><span class="line"></span><br><span class="line">@implementation ViewController</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    // Do any additional setup after loading the view, typically from a nib.</span><br><span class="line">    </span><br><span class="line">    Car *car = [[Car alloc] init];</span><br><span class="line">    [car setValue:@&quot;四驱&quot; forKey:@&quot;engine&quot;];</span><br><span class="line">    [car valueForKey:@&quot;engine&quot;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">// Car.m</span><br><span class="line">#import &quot;Car.h&quot;</span><br><span class="line"></span><br><span class="line">@interface Car ()</span><br><span class="line">&#123;</span><br><span class="line">    NSString *carEngine;</span><br><span class="line">    NSString *_engine;</span><br><span class="line">    NSString *_isEngine;</span><br><span class="line">    NSString *engine;</span><br><span class="line">    NSString *isEngine;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation Car</span><br><span class="line">- (void)setEngine:(id)engine &#123;</span><br><span class="line">    carEngine = engine;</span><br><span class="line">    NSLog(@&quot;%s-----carEngine=%@&quot;, __func__, carEngine);</span><br><span class="line">&#125;</span><br><span class="line">- (NSString *)engine &#123;</span><br><span class="line">    NSLog(@&quot;%s-----carEngine=%@&quot;, __func__, carEngine);</span><br><span class="line">    return carEngine;</span><br><span class="line">&#125;</span><br><span class="line">+ (BOOL)accessInstanceVariablesDirectly &#123;</span><br><span class="line">    NSLog(@&quot;%s&quot;, __func__);</span><br><span class="line">    return YES;</span><br><span class="line">&#125;</span><br><span class="line">- (void)setValue:(id)value forKey:(NSString *)key &#123;</span><br><span class="line">    NSLog(@&quot;%s&quot;, __func__);</span><br><span class="line">    [super setValue:value forKey:key];</span><br><span class="line">&#125;</span><br><span class="line">- (id)valueForKey:(NSString *)key &#123;</span><br><span class="line">    NSLog(@&quot;%s&quot;, __func__);</span><br><span class="line">    return [super valueForKey:key];</span><br><span class="line">&#125;</span><br><span class="line">- (id)valueForUndefinedKey:(NSString *)key &#123;</span><br><span class="line">    NSLog(@&quot;%s----出现异常，该key不存在%@&quot;, __func__, key);</span><br><span class="line">    return nil;</span><br><span class="line">&#125;</span><br><span class="line">- (void)setValue:(id)value forUndefinedKey:(NSString *)key &#123;</span><br><span class="line">    NSLog(@&quot;%s----出现异常，该key不存在%@&quot;, __func__, key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>执行以上，代码输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-[Car setValue:forKey:]</span><br><span class="line">-[Car setEngine:]-----carEngine=四驱</span><br><span class="line">-[Car valueForKey:]</span><br><span class="line">-[Car engine]-----carEngine=四驱</span><br></pre></td></tr></table></figure>
<p>首先，我们看到，通过 KVC 我们对 <code>Car</code>的私有属性进行了赋值和取值。</p>
<p>继续看下面的代码，同时<strong>把<code>Car</code>类里边的set方法注释，accessInstanceVariablesDirectly返回NO</strong>，然后代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// Car.m</span><br><span class="line">/*</span><br><span class="line">- (void)setEngine:(id)engine &#123;</span><br><span class="line">    carEngine = engine;</span><br><span class="line">    NSLog(@&quot;%s-----carEngine=%@&quot;, __func__, carEngine);</span><br><span class="line">&#125;</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">+ (BOOL)accessInstanceVariablesDirectly &#123;</span><br><span class="line">    NSLog(@&quot;%s&quot;, __func__);</span><br><span class="line">    return NO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ViewController.m</span><br><span class="line">[car setValue:@&quot;四驱&quot; forKey:@&quot;engine&quot;];</span><br></pre></td></tr></table></figure>
<p>打印：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-[Car setValue:forKey:]</span><br><span class="line">+[Car accessInstanceVariablesDirectly]</span><br><span class="line">-[Car setValue:forUndefinedKey:]----出现异常，该key不存在engine</span><br></pre></td></tr></table></figure>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>那么，在调用<code>- (void)setValue:(nullable id)value forKey:(NSString *)key;</code>到底做了什么呢？</p>
<ul>
<li><p>如果没有找到<code>setEngine：</code>方法，KVC机制会检查<code>+ (BOOL)accessInstanceVariablesDirectly</code>方法有没有返回YES，默认该方法会返回YES。如果你重写了该方法让其返回NO的话，那么在这一步KVC会执行<code>setValue：forUndefinedKey：</code>方法，不过一般开发者不会这么做。所以KVC机制会搜索该类里面有没有名为<code>_&lt;key&gt;</code>的成员变量，无论该变量是在类接口处定义，还是在类实现处定义，也无论用了什么样的访问修饰符，只要存在以<code>_&lt;key&gt;</code>命名的变量，KVC都可以对该成员变量赋值。</p>
</li>
<li><p>如果该类即没有<code>set&lt;key&gt;：</code>方法，也没有<code>_&lt;key&gt;</code>成员变量，KVC机制会搜索<code>_is&lt;Key&gt;</code>的成员变量。</p>
</li>
<li><p>和上面一样，如果该类即没有<code>set&lt;Key&gt;：</code>方法，也没有<code>_&lt;key&gt;</code>和<code>_is&lt;Key&gt;</code>成员变量，KVC机制再会继续搜索<code>&lt;key&gt;</code>和<code>is&lt;Key&gt;</code>的成员变量。再给它们赋值。</p>
</li>
<li><p>如果上面列出的方法或者成员变量都不存在，系统将会执行该对象的<code>setValue：forUndefinedKey：</code>方法，默认是抛出异常。</p>
</li>
</ul>
<p>为了节省篇幅，剩下的的KVC对于<code>key</code>寻找机制就不在这里展示了，有兴趣的读者可以写代码去验证。</p>
<h3 id="取值"><a href="#取值" class="headerlink" title="取值"></a>取值</h3><blockquote>
<p>The default implementation of this method does the following:</p>
<ol>
<li><p>Searches the class of the receiver for an accessor method whose name matches the pattern -get<key>, -<key>, or -is<key>, in that order. If such a method is found it is invoked. If the type of the method’s result is an object pointer type the result is simply returned. If the type of the result is one of the scalar types supported by NSNumber conversion is done and an NSNumber is returned. Otherwise, conversion is done and an NSValue is returned (new in Mac OS 10.5: results of arbitrary type are converted to NSValues, not just NSPoint, NRange, NSRect, and NSSize).</key></key></key></p>
</li>
<li><p>(introduced in Mac OS 10.7)Otherwise (no simple accessor method is found), searches the class of the receiver for methods whose names match the patterns -countOf<key> and -indexIn<key>OfObject: and -objectIn<key>AtIndex: (corresponding to the primitive methods defined by the NSOrderedSet class) and also -<key>AtIndexes: (corresponding to -[NSOrderedSet objectsAtIndexes:]). If a count method and an indexOf method and at least one of the other two possible methods are found, a collection proxy object that responds to all NSOrderedSet methods is returned. Each NSOrderedSet message sent to the collection proxy object will result in some combination of -countOf<key>, -indexIn<key>OfObject:, -objectIn<key>AtIndex:, and -<key>AtIndexes: messages being sent to the original receiver of -valueForKey:. If the class of the receiver also implements an optional method whose name matches the pattern -get<key>:range: that method will be used when appropriate for best performance.</key></key></key></key></key></key></key></key></key></p>
</li>
<li><p>Otherwise (no simple accessor method or set of ordered set access methods is found), searches the class of the receiver for methods whose names match the patterns -countOf<key> and -objectIn<key>AtIndex: (corresponding to the primitive methods defined by the NSArray class) and (introduced in Mac OS 10.4) also -<key>AtIndexes: (corresponding to -[NSArray objectsAtIndexes:]). If a count method and at least one of the other two possible methods are found, a collection proxy object that responds to all NSArray methods is returned. Each NSArray message sent to the collection proxy object will result in some combination of -countOf<key>, -objectIn<key>AtIndex:, and -<key>AtIndexes: messages being sent to the original receiver of -valueForKey:. If the class of the receiver also implements an optional method whose name matches the pattern -get<key>:range: that method will be used when appropriate for best performance.</key></key></key></key></key></key></key></p>
<ol start="4">
<li>(introduced in Mac OS 10.4) Otherwise (no simple accessor method or set of ordered set or array access methods is found), searches the class of the receiver for a threesome of methods whose names match the patterns -countOf<key>, -enumeratorOf<key>, and -memberOf<key>: (corresponding to the primitive methods defined by the NSSet class). If all three such methods are found a collection proxy object that responds to all NSSet methods is returned. Each NSSet message sent to the collection proxy object will result in some combination of -countOf<key>, -enumeratorOf<key>, and -memberOf<key>: messages being sent to the original receiver of -valueForKey:.</key></key></key></key></key></key></li>
</ol>
</li>
<li><p>Otherwise (no simple accessor method or set of collection access methods is found), if the receiver’s class’ +accessInstanceVariablesDirectly property returns YES, searches the class of the receiver for an instance variable whose name matches the pattern _<key>, _is<key>, <key>, or is<key>, in that order. If such an instance variable is found, the value of the instance variable in the receiver is returned, with the same sort of conversion to NSNumber or NSValue as in step 1.</key></key></key></key></p>
</li>
<li><p>Otherwise (no simple accessor method, set of collection access methods, or instance variable is found), invokes -valueForUndefinedKey: and returns the result. The default implementation of -valueForUndefinedKey: raises an NSUndefinedKeyException, but you can override it in your application.</p>
</li>
</ol>
</blockquote>
<p>上边的英文不做过多解释，直接上代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// Car.m</span><br><span class="line">/*</span><br><span class="line">- (NSString *)engine &#123;</span><br><span class="line">    NSLog(@&quot;%s-----carEngine=%@&quot;, __func__, carEngine);</span><br><span class="line">    return carEngine;</span><br><span class="line">&#125;</span><br><span class="line">*/</span><br><span class="line">+ (BOOL)accessInstanceVariablesDirectly &#123;</span><br><span class="line">    NSLog(@&quot;%s&quot;, __func__);</span><br><span class="line">    return NO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ViewController.m</span><br><span class="line">[car valueForKey:@&quot;engine&quot;];</span><br></pre></td></tr></table></figure>
<p>打印：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-[Car valueForKey:]</span><br><span class="line">+[Car accessInstanceVariablesDirectly]</span><br><span class="line">-[Car valueForUndefinedKey:]----出现异常，该key不存在engine</span><br></pre></td></tr></table></figure>
<h3 id="关于keyPath"><a href="#关于keyPath" class="headerlink" title="关于keyPath"></a>关于keyPath</h3><p>在开发过程中，一个类的成员变量有可能是自定义类或其他的复杂数据类型，你可以先用KVC获取该属性，然后再次用KVC来获取这个自定义类的属性，但这样是比较繁琐的，对此，KVC提供了一个解决方案，那就是键路径<code>keyPath</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">// Wheel.h</span><br><span class="line">@interface Wheel : NSObject</span><br><span class="line"></span><br><span class="line">@property (nonatomic, assign) NSInteger num;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">// Car.h</span><br><span class="line">#import &lt;Foundation/Foundation.h&gt;</span><br><span class="line">#import &quot;Wheel.h&quot;</span><br><span class="line">    </span><br><span class="line">@interface Car : NSObject</span><br><span class="line">// 车牌号</span><br><span class="line">@property (nonatomic, copy) NSString *licensePlateNumber;</span><br><span class="line">// 车轮</span><br><span class="line">@property (nonatomic, strong) Wheel *w;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">// ViewController.m</span><br><span class="line">Car *car = [[Car alloc] init];</span><br><span class="line">Wheel *w = [[Wheel alloc] init];</span><br><span class="line">w.num = 2;</span><br><span class="line">car.w = w;</span><br><span class="line">NSInteger number = [[car valueForKeyPath:@&quot;w.num&quot;] integerValue];</span><br><span class="line">NSLog(@&quot;这是%d轮，摩托车&quot;, number);</span><br><span class="line"></span><br><span class="line">[car setValue:@&quot;3&quot; forKeyPath:@&quot;w.num&quot;];</span><br><span class="line">NSInteger number2 = [[car valueForKeyPath:@&quot;w.num&quot;] integerValue];</span><br><span class="line">NSLog(@&quot;这是%d轮车&quot;, number2);</span><br></pre></td></tr></table></figure>
<p>打印：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-[Car valueForKey:]</span><br><span class="line">这是2轮，摩托车</span><br><span class="line">-[Car valueForKey:]</span><br><span class="line">-[Car valueForKey:]</span><br><span class="line">这是3轮车</span><br></pre></td></tr></table></figure>
<p>使用<code>keyPath</code>是用小数点<code>.</code>来分割<code>key</code>，然后再像普通<code>key</code>一样按照先前介绍的顺序搜索下去。</p>
<h3 id="使用KVC中遇到的Crash"><a href="#使用KVC中遇到的Crash" class="headerlink" title="使用KVC中遇到的Crash"></a>使用KVC中遇到的Crash</h3><p>第一种情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[car setValue:nil forKey:@&quot;licensePlateNumber&quot;];</span><br><span class="line"></span><br><span class="line">*** Terminating app due to uncaught exception &apos;NSInvalidArgumentException&apos;, reason: &apos;[&lt;Car 0x100300060&gt; setNilValueForKey]: could not set nil as the value for the key licensePlateNumber.&apos; // 调用setNilValueForKey抛出异常</span><br></pre></td></tr></table></figure>
<p>处理方案，重写<code>setNilValueForKey</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-(void)setNilValueForKey:(NSString *)key&#123;</span><br><span class="line">    NSLog(@&quot;%@不能为nil&quot;,key); // licensePlateNumber不能为nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第二种情况如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*** Terminating app due to uncaught exception &apos;NSUnknownKeyException&apos;, reason: &apos;[&lt;__NSCFConstantString 0x10e1450b8&gt; valueForUndefinedKey:]: this class is not key value coding-compliant for the key num.&apos;</span><br></pre></td></tr></table></figure>
<p>以上多数是<code>setValue:forKey</code>、<code>setValue:forKeyPath</code>的<code>key(Path)</code>参数手误，写错了。</p>
<h2 id="KVC-如此强大"><a href="#KVC-如此强大" class="headerlink" title="KVC 如此强大"></a>KVC 如此强大</h2><h3 id="KVC-与集合"><a href="#KVC-与集合" class="headerlink" title="KVC 与集合"></a>KVC 与集合</h3><h4 id="简单集合运算符共有-avg-count-max-min-sum5种"><a href="#简单集合运算符共有-avg-count-max-min-sum5种" class="headerlink" title="简单集合运算符共有@avg/@count/@max/@min/@sum5种"></a>简单集合运算符共有<code>@avg/@count/@max/@min/@sum5</code>种</h4><h4 id="对象运算符"><a href="#对象运算符" class="headerlink" title="对象运算符"></a>对象运算符</h4><p>比集合运算符稍微复杂，能以数组的方式返回指定的内容，一共有两种：<br><code>@distinctUnionOfObjects</code>，返回的元素都是去重以后的结果<br><code>@unionOfObjects</code>，返回的元素是全集<br>它们的返回值都是<code>NSArray</code></p>
<h4 id="Array和Set操作符"><a href="#Array和Set操作符" class="headerlink" title="Array和Set操作符"></a>Array和Set操作符</h4><p>集合中包含集合的情况，我们执行了如下的一段代码：<br> @distinctUnionOfArrays<br> @unionOfArrays<br> @distinctUnionOfSets<br> <code>@distinctUnionOfArrays：</code>该操作会返回一个数组，这个数组包含不同的对象，不同的对象是在从关键路径到操作器右边的被指定的属性里；<br> <code>@unionOfArrays</code> 该操作会返回一个数组，这个数组包含的对象是在从关键路径到操作器右边的被指定的属性里和@distinctUnionOfArrays不一样，重复的对象不会被移除；<br> <code>@distinctUnionOfSets</code> 和<code>@distinctUnionOfArrays</code>类似。因为<code>Set</code>本身就不支持重复。</p>
<h3 id="Model和字典转换"><a href="#Model和字典转换" class="headerlink" title="Model和字典转换"></a>Model和字典转换</h3><p>运用KVC和Objc的<code>runtime</code>组合的技巧，可以实现模型与字典的转换。</p>
<h3 id="KVC动态的取值和赋值"><a href="#KVC动态的取值和赋值" class="headerlink" title="KVC动态的取值和赋值"></a>KVC动态的取值和赋值</h3><p>利用KVC动态的取值和设值是最基本的用途，同时在KVC面前，私有变量就是纸老虎，可以呼来喝去~~</p>
<p>###KVC+runtime可以修改一些控件的内部属性</p>
<p>比如，修改 <code>UITextField</code>中的<code>Placeholder</code>文字样式。注意要导入<code>#import&lt;objc/runtime.h&gt;</code>头文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">UITextField *text = [[UITextField alloc] initWithFrame:CGRectMake(0, 0, 300.f, 100.f)];</span><br><span class="line">[text setValue:[UIColor redColor] forKey:@&quot;_placeholderLabel.textColor&quot;];</span><br><span class="line"></span><br><span class="line">// _placeholderLabel 这个属性是通过 runtime 获得的</span><br></pre></td></tr></table></figure>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ul>
<li>Foundation/NSKeyValueCoding.h</li>
<li><a href="https://www.cnblogs.com/powerauras/p/3323497.html" target="_blank" rel="noopener">bug更正利用KVC和associative特性在NSObject中存储键值</a></li>
<li><a href="https://www.jianshu.com/p/d12dba8d686c" target="_blank" rel="noopener">kvc 进阶（一）</a></li>
<li><a href="https://www.jianshu.com/p/45cbd324ea65" target="_blank" rel="noopener">iOS开发技巧系列—详解KVC(我告诉你KVC的一切)</a></li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/kvc/" rel="tag"># kvc</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/04/03/2016-4-3-cocoaPods的简单使用/" rel="next" title="CocoaPods的简单使用">
                <i class="fa fa-chevron-left"></i> CocoaPods的简单使用
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/04/28/2016-4-28-KVO的使用/" rel="prev" title="KVO的使用">
                KVO的使用 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="karl">
            
              <p class="site-author-name" itemprop="name">karl</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">113</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">24</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">87</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/likenow" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:fmslikai@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://yujiangshui.com/" title="yujiangshui" target="_blank">yujiangshui</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#KVC"><span class="nav-number">1.</span> <span class="nav-text">KVC</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#理解-KVC"><span class="nav-number">2.</span> <span class="nav-text">理解 KVC</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#赋值"><span class="nav-number">2.1.</span> <span class="nav-text">赋值</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#小结"><span class="nav-number">2.1.1.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#取值"><span class="nav-number">2.2.</span> <span class="nav-text">取值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关于keyPath"><span class="nav-number">2.3.</span> <span class="nav-text">关于keyPath</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用KVC中遇到的Crash"><span class="nav-number">2.4.</span> <span class="nav-text">使用KVC中遇到的Crash</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#KVC-如此强大"><span class="nav-number">3.</span> <span class="nav-text">KVC 如此强大</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#KVC-与集合"><span class="nav-number">3.1.</span> <span class="nav-text">KVC 与集合</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#简单集合运算符共有-avg-count-max-min-sum5种"><span class="nav-number">3.1.1.</span> <span class="nav-text">简单集合运算符共有@avg/@count/@max/@min/@sum5种</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#对象运算符"><span class="nav-number">3.1.2.</span> <span class="nav-text">对象运算符</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Array和Set操作符"><span class="nav-number">3.1.3.</span> <span class="nav-text">Array和Set操作符</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Model和字典转换"><span class="nav-number">3.2.</span> <span class="nav-text">Model和字典转换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#KVC动态的取值和赋值"><span class="nav-number">3.3.</span> <span class="nav-text">KVC动态的取值和赋值</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考文献"><span class="nav-number">4.</span> <span class="nav-text">参考文献</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2013 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">karl</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
