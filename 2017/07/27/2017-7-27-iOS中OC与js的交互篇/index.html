<!DOCTYPE html>




<html class="theme-next gemini" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="oc,javascript,webview,JSBridge,">










<meta name="description" content="前言在文章的一开始，我想先解释几个开发的名词：Native/Web App/Hybrid/React Native/Weex  Native App 是一种基于智能手机本地操作系统如 iOS、Android 等，并使用原生程式编写运行的第三方应用程序，也叫本地 App。 一般使用的开发语言为JAVA、C++、Objective-C   web App 是移动端的网站，常被称为H5应用，说白了就是特">
<meta name="keywords" content="oc,javascript,webview,JSBridge">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS中OC与js的交互篇">
<meta property="og:url" content="http://yoursite.com/2017/07/27/2017-7-27-iOS中OC与js的交互篇/index.html">
<meta property="og:site_name" content="Karl&#39;s Blog">
<meta property="og:description" content="前言在文章的一开始，我想先解释几个开发的名词：Native/Web App/Hybrid/React Native/Weex  Native App 是一种基于智能手机本地操作系统如 iOS、Android 等，并使用原生程式编写运行的第三方应用程序，也叫本地 App。 一般使用的开发语言为JAVA、C++、Objective-C   web App 是移动端的网站，常被称为H5应用，说白了就是特">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://kailee.b0.upaiyun.com/jsvalueStrongRef2017.png">
<meta property="og:image" content="http://kailee.b0.upaiyun.com/ocblockinjs2017.png">
<meta property="og:image" content="http://kailee.b0.upaiyun.com/colorfromwork2017.png">
<meta property="og:image" content="http://kailee.b0.upaiyun.com/jsmanagedvalueref2017.png">
<meta property="og:updated_time" content="2018-11-05T15:00:10.630Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS中OC与js的交互篇">
<meta name="twitter:description" content="前言在文章的一开始，我想先解释几个开发的名词：Native/Web App/Hybrid/React Native/Weex  Native App 是一种基于智能手机本地操作系统如 iOS、Android 等，并使用原生程式编写运行的第三方应用程序，也叫本地 App。 一般使用的开发语言为JAVA、C++、Objective-C   web App 是移动端的网站，常被称为H5应用，说白了就是特">
<meta name="twitter:image" content="http://kailee.b0.upaiyun.com/jsvalueStrongRef2017.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/07/27/2017-7-27-iOS中OC与js的交互篇/">





  <title>iOS中OC与js的交互篇 | Karl's Blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?d714d594e46d4e86189e49fe568d871a";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Karl's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/27/2017-7-27-iOS中OC与js的交互篇/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="karl">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Karl's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">iOS中OC与js的交互篇</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-27T23:40:37+08:00">
                2017-07-27
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在文章的一开始，我想先解释几个开发的名词：<code>Native</code>/<code>Web App</code>/<code>Hybrid</code>/<code>React Native</code>/<code>Weex</code></p>
<blockquote>
<p><strong>Native</strong> App <strong>是</strong>一种基于智能手机本地操作系统如 iOS、Android 等，并使用原生程式编写运行的第三方应用程序，也叫本地 App。 一般使用的<strong>开发</strong>语言为<strong>JAVA</strong>、<strong>C++</strong>、<strong>Objective-C</strong></p>
</blockquote>
<blockquote>
<p><strong>web </strong>App 是移动端的网站，常被称为<strong>H5</strong>应用，说白了就是特定运行在移动端浏览器上的网站应用。一般泛指 SPA(Single Page Application)模式开发出的网站，与MPA（Multi-page Application）对应。</p>
</blockquote>
<blockquote>
<p><strong>Hybrid</strong>  App 是混合模式移动应用，介于Web App、Native App<strong>这两者之间</strong>的App开发技术，兼具“Native App良好交互体验的优势”和“ Web App 跨平台开发的优势”（百度百科）</p>
</blockquote>
<blockquote>
<p><strong>React Native</strong> 是 Facebook 开源的App开发方案，简称<strong>RN</strong>。使用<strong>JSX</strong>语言写原生界面，<strong>js</strong>通过<strong>jsBridge</strong>调用原生API渲染UI交互通信。</p>
</blockquote>
<blockquote>
<p><strong>weex</strong> 是Alibaba 开源的一套开发方案，团队称借鉴<strong>RN</strong>的优秀案例并有淘宝众多业务实践场景，备受开发者关注。2016年4月正式开源，并在<strong>Vue2.0</strong>版本官方支持<strong>Vue.js</strong>，也就有了人们口中的<strong>Vue Native</strong>。</p>
</blockquote>
<p>那么现在看来，开发一款移动应用就有了以上几种优秀的技术方案。而我，作为一个 Native 移动应用开发者而且是一名iOS开发者也应该紧追时代步伐，学习前端开发语言（javascript/css/html），学习前端开发的技术解决方案，诸如 React、Vue 等优秀的技术框架。 </p>
<p>这样一来，我们不难看出，<strong>native 端 js 与 oc（or java）的交互</strong>是<code>Web App</code>/<code>Hybrid</code>/<code>React Native</code>/<code>Weex</code>几种方案的<strong>核心</strong>功能模块。这也就是本文着重要讲的地方。</p>
<a id="more"></a>
<h2 id="基于-JavaScriptCore-框架-实现-jsoc"><a href="#基于-JavaScriptCore-框架-实现-jsoc" class="headerlink" title="基于 JavaScriptCore 框架 实现 jsoc"></a>基于 JavaScriptCore 框架 实现 js<->oc</-></h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><code>JavaScriptCore框架</code> 是一个苹果在<code>iOS7</code>引入的框架，该框架让<code>Objective-C</code> 和<code>JavaScript</code> 代码直接的交互变得更加的简单方便。</p>
<p><code>JavaScriptCore框架</code>其实就是基于<code>webkit</code>中以<code>C/C++</code>实现的<code>JavaScriptCore</code>的一个包装即提供了Objective-C的封装接口。在旧版本iOS开发中，很多开发者也会自行将<code>webkit</code>编译出<code>JavaScriptCore.a</code>库引入项目编译使用。现在iOS7把它当成了标准库。</p>
<h3 id="oc-与-javascript-交互"><a href="#oc-与-javascript-交互" class="headerlink" title="oc 与 javascript 交互"></a>oc 与 javascript 交互</h3><h4 id="JSContext"><a href="#JSContext" class="headerlink" title="JSContext"></a>JSContext</h4><ul>
<li>JSContext 为JS代码的执行提供了上下文环境，通过<code>jSCore</code>执行的JS代码都得通过JSContext来执行。</li>
<li>JSContext 对应于一个 JS 中的全局对象。JSContext对应着一个<code>全局对象</code>，相当于浏览器中的<code>window对象</code>，JSContext中有一个<code>GlobalObject</code>属性，实际上JS代码都是在这个<code>GlobalObject</code>上执行的，但是为了容易理解，可以把JSContext等价于全局对象。</li>
</ul>
<h4 id="JSValue"><a href="#JSValue" class="headerlink" title="JSValue"></a>JSValue</h4><ul>
<li>JSValue 是对 JS 值的包装，就相当于JS 中的 var。</li>
</ul>
<table>
<thead>
<tr>
<th>JavaScript Type</th>
<th><code>JSValue</code> method</th>
<th>Objective-C Type</th>
<th>Swift Type</th>
</tr>
</thead>
<tbody>
<tr>
<td>string</td>
<td><code>toString</code></td>
<td><code>NSString</code></td>
<td><code>String!</code></td>
</tr>
<tr>
<td>boolean</td>
<td><code>toBool</code></td>
<td><code>BOOL</code></td>
<td><code>Bool</code></td>
</tr>
<tr>
<td>number</td>
<td><code>toNumber</code> <code>toDouble</code> <code>toInt32</code> <code>toUInt32</code></td>
<td><code>NSNumber</code> <code>double</code> <code>int32_t</code> <code>uint32_t</code></td>
<td><code>NSNumber!</code> <code>Double</code> <code>Int32</code> <code>UInt32</code></td>
</tr>
<tr>
<td>Date</td>
<td><code>toDate</code></td>
<td><code>NSDate</code></td>
<td><code>NSDate!</code></td>
</tr>
<tr>
<td>Array</td>
<td><code>toArray</code></td>
<td><code>NSArray</code></td>
<td><code>[AnyObject]!</code></td>
</tr>
<tr>
<td>Object</td>
<td><code>toDictionary</code></td>
<td><code>NSDictionary</code></td>
<td><code>[NSObject : AnyObject]!</code></td>
</tr>
<tr>
<td>Object</td>
<td><code>toObject</code> <code>toObjectOfClass:</code></td>
<td><em>custom type</em></td>
<td><em>custom type</em></td>
</tr>
</tbody>
</table>
<ul>
<li><p>JSValue 存在于 JSContext 中，它必须存在于某一个JSContext中，就像浏览器中所有的元素都包含于<code>Window对象</code>中一样，一个JSContext中可以包含多个JSValue。</p>
</li>
<li><p><strong>都是强引用</strong><br>这点很关键，JSValue对其对应的JS值和其所属的JSContext对象都是强引用的关系。因为jSValue需要这两个东西来执行JS代码，所以JSValue会一直持有着它们。下面这张图可以更直观的描述出它们之间的关系：</p>
</li>
</ul>
<p><img src="http://kailee.b0.upaiyun.com/jsvalueStrongRef2017.png" alt="img"></p>
<p>通过下面这些方法来创建一个JSValue对象：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">/*!</span><br><span class="line">@methodgroup Creating JavaScript Values</span><br><span class="line">*/</span><br><span class="line">/*!</span><br><span class="line">@method</span><br><span class="line">@abstract Create a JSValue by converting an Objective-C object.</span><br><span class="line">@discussion The resulting JSValue retains the provided Objective-C object.</span><br><span class="line">@param value The Objective-C object to be converted.</span><br><span class="line">@result The new JSValue.</span><br><span class="line">*/</span><br><span class="line">+ (JSValue *)valueWithObject:(id)value inContext:(JSContext *)context;</span><br><span class="line"></span><br><span class="line">/*!</span><br><span class="line">@method</span><br><span class="line">@abstract Create a JavaScript value from a BOOL primitive.</span><br><span class="line">@param context The JSContext in which the resulting JSValue will be created.</span><br><span class="line">@result The new JSValue representing the equivalent boolean value.</span><br><span class="line">*/</span><br><span class="line">+ (JSValue *)valueWithBool:(BOOL)value inContext:(JSContext *)context;</span><br><span class="line"></span><br><span class="line">/*!</span><br><span class="line">@method</span><br><span class="line">@abstract Create a JavaScript value from a double primitive.</span><br><span class="line">@param context The JSContext in which the resulting JSValue will be created.</span><br><span class="line">@result The new JSValue representing the equivalent boolean value.</span><br><span class="line">*/</span><br><span class="line">+ (JSValue *)valueWithDouble:(double)value inContext:(JSContext *)context;</span><br><span class="line"></span><br><span class="line">/*!</span><br><span class="line">@method</span><br><span class="line">@abstract Create a JavaScript value from an &lt;code&gt;int32_t&lt;/code&gt; primitive.</span><br><span class="line">@param context The JSContext in which the resulting JSValue will be created.</span><br><span class="line">@result The new JSValue representing the equivalent boolean value.</span><br><span class="line">*/</span><br><span class="line">+ (JSValue *)valueWithInt32:(int32_t)value inContext:(JSContext *)context;</span><br><span class="line"></span><br><span class="line">/*!</span><br><span class="line">@method</span><br><span class="line">@abstract Create a JavaScript value from a &lt;code&gt;uint32_t&lt;/code&gt; primitive.</span><br><span class="line">@param context The JSContext in which the resulting JSValue will be created.</span><br><span class="line">@result The new JSValue representing the equivalent boolean value.</span><br><span class="line">*/</span><br><span class="line">+ (JSValue *)valueWithUInt32:(uint32_t)value inContext:(JSContext *)context;</span><br><span class="line"></span><br><span class="line">/*!</span><br><span class="line">@method</span><br><span class="line">@abstract Create a new, empty JavaScript object.</span><br><span class="line">@param context The JSContext in which the resulting object will be created.</span><br><span class="line">@result The new JavaScript object.</span><br><span class="line">*/</span><br><span class="line">+ (JSValue *)valueWithNewObjectInContext:(JSContext *)context;</span><br><span class="line"></span><br><span class="line">/*!</span><br><span class="line">@method</span><br><span class="line">@abstract Create a new, empty JavaScript array.</span><br><span class="line">@param context The JSContext in which the resulting array will be created.</span><br><span class="line">@result The new JavaScript array.</span><br><span class="line">*/</span><br><span class="line">+ (JSValue *)valueWithNewArrayInContext:(JSContext *)context;</span><br><span class="line"></span><br><span class="line">/*!</span><br><span class="line">@method</span><br><span class="line">@abstract Create a new JavaScript regular expression object.</span><br><span class="line">@param pattern The regular expression pattern.</span><br><span class="line">@param flags The regular expression flags.</span><br><span class="line">@param context The JSContext in which the resulting regular expression object will be created.</span><br><span class="line">@result The new JavaScript regular expression object.</span><br><span class="line">*/</span><br><span class="line">+ (JSValue *)valueWithNewRegularExpressionFromPattern:(NSString *)pattern flags:(NSString *)flags inContext:(JSContext *)context;</span><br><span class="line"></span><br><span class="line">/*!</span><br><span class="line">@method</span><br><span class="line">@abstract Create a new JavaScript error object.</span><br><span class="line">@param message The error message.</span><br><span class="line">@param context The JSContext in which the resulting error object will be created.</span><br><span class="line">@result The new JavaScript error object.</span><br><span class="line">*/</span><br><span class="line">+ (JSValue *)valueWithNewErrorFromMessage:(NSString *)message inContext:(JSContext *)context;</span><br><span class="line"></span><br><span class="line">/*!</span><br><span class="line">@method</span><br><span class="line">@abstract Create the JavaScript value &lt;code&gt;null&lt;/code&gt;.</span><br><span class="line">@param context The JSContext to which the resulting JSValue belongs.</span><br><span class="line">@result The JSValue representing the JavaScript value &lt;code&gt;null&lt;/code&gt;.</span><br><span class="line">*/</span><br><span class="line">+ (JSValue *)valueWithNullInContext:(JSContext *)context;</span><br><span class="line"></span><br><span class="line">/*!</span><br><span class="line">@method</span><br><span class="line">@abstract Create the JavaScript value &lt;code&gt;undefined&lt;/code&gt;.</span><br><span class="line">@param context The JSContext to which the resulting JSValue belongs.</span><br><span class="line">@result The JSValue representing the JavaScript value &lt;code&gt;undefined&lt;/code&gt;.</span><br><span class="line">*/</span><br><span class="line">+ (JSValue *)valueWithUndefinedInContext:(JSContext *)context;</span><br></pre></td></tr></table></figure>
<p>你可以将OC中的类型，转换成JS中的对应的类型（参见前面那个类型对照表），并包装在JSValue中，包括基本类型，<code>Null</code>和<code>undfined</code>。</p>
<p>或者你也可以创建一个新的对象，数组，正则表达式，错误，这几个方法达到的效果就相当于在JS中写 <code>var a = new Array();</code></p>
<p>也可以将一个OC对象，转成JS中的对象，但是这样转换后的对象中的属性和方法，在JS中是获取不到的，怎样才能让JS中获取的OC对象中的属性和方法，我们后面再说。</p>
<h4 id="实际使用"><a href="#实际使用" class="headerlink" title="实际使用"></a>实际使用</h4><p>首先，从<code>bundle</code>中加载这段JS代码。 </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> factorial = <span class="function"><span class="keyword">function</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (n&lt;<span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> n * factorial(n<span class="number">-1</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>如下代码，实现在oc中调用<code>factorial</code>函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NSString *factorialStr = [self loadJSBundle];</span><br><span class="line">JSContext *context = [[JSContext alloc] init];</span><br><span class="line">JSValue *value = [context evaluateScript:factorialStr];</span><br><span class="line"></span><br><span class="line">JSValue *func = context[@&quot;factorial&quot;];</span><br><span class="line">JSValue *result = [func callWithArguements:@[@10]];</span><br></pre></td></tr></table></figure>
<p>上述代码，创建一个JSContext，并用他来执行这段JS代码，这句的效果就相当于在一个全局对象中声明了一个叫<code>fatorial</code>的函数，但是没有调用它，只是声明，所以执行完这段JS代码后没有返回值。</p>
<p>再从这个全局对象中获取这个函数，这里我们用到了一种类似字典的下标写法来获取对应的JS函数，就像在一个字典中取这个key对应的value一样简单，实际上，JS中的对象就是以 <code>key : Value</code> 的形式存储属性的，且JS中的<code>object对象类型</code>，对应到OC中就是<code>字典类型</code>，所以这种写法自然且合理。</p>
<blockquote>
<p>这种类似字典的下标方式不仅可以取值，也可以存值。不仅可以作用于Context，也可以作用与JSValue，他会用中括号中填的key值去匹配JSValue包含的JS值中有没有对应的属性字段，找到了就返回，没找到就返回undefined。</p>
</blockquote>
<p>然后，我们拿到了包装这个阶乘函数的的JSValue对象，在其上调用<code>callWithArguments</code>方法，即可调用该函数，这个方法接收一个数组为参数，这是因为JS中的函数的参数都不是固定的，我们构建了一个数组，并把<code>NSNumber</code>类型的10传了过去（ 这里会把NSNumber类型转成JS中number类型）然后再去调用这个函数。</p>
<p>最后，如果函数有返回值，就会将函数返回值返回，如果没有返回值则返回undefined，当然在经过JSCore之后，这些JS中的类型都被包装成了JSValue，最后我们拿到返回的JSValue对象，转成对应的类型并输出。</p>
<h3 id="javascript-与-oc-交互"><a href="#javascript-与-oc-交互" class="headerlink" title="javascript 与 oc 交互"></a>javascript 与 oc 交互</h3><p>JavaScript 与 Objective-C 交互主要通过2种方式：</p>
<ul>
<li><strong>Block</strong> : 第一种方式是使用block，block也可以称作闭包和匿名函数，使用block可以很方便的将OC中的单个方法暴露给JS调用，具体实现我们稍后再说。</li>
<li><strong>JSExport 协议</strong> : 第二种方式，是使用<code>JSExport</code>协议，可以将OC的中某个对象直接暴露给JS使用，而且在JS中使用就像调用JS的对象一样自然。</li>
</ul>
<p>简而言之，Block是用来暴露单个方法的，而JSExport 协议可以暴露一个OC对象，下面我们详细说一下这两种方式。</p>
<h4 id="Block"><a href="#Block" class="headerlink" title="Block"></a>Block</h4><p>上面说过，使用Block可以很方便的将OC中的单个方法(即Block)暴露给JS调用，JSCore会自动将这个Block包装成一个JS方法，上代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">context[@&quot;makeUIColor&quot;] = ^(NSDictionary *rgba) &#123;</span><br><span class="line">    float *r = [color[@&quot;red&quot;] floatValue];</span><br><span class="line">    float *g = [color[@&quot;green&quot;] floatValue];</span><br><span class="line">    float *b = [color[@&quot;blue&quot;] floatValue];</span><br><span class="line">    float *a = [color[@&quot;alpha&quot;] floatValue];</span><br><span class="line">    return [UIColor colorWithRed:r/255.0 green:g/255.0 blue:b/255.0 alpha:a];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>把一个OC Block注入了context中，这个block接收一个NSDictionary类型的参数，并返回了一个<code>UIColor</code>类型的对象。JSCore会自动在全局对象中(因为是直接在Context上赋值的，context对应于全局对象)创建一个叫<code>makeUIColor</code>的函数，将这个Block包装起来。如图：</p>
<p><img src="http://kailee.b0.upaiyun.com/ocblockinjs2017.png" alt="img"></p>
<p>然后，在JS中，我们来调用这个暴露过来的block，其实直接调用的是那个封装着Block的<code>MakeUIColor</code>方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> colorFromWord = <span class="function"><span class="keyword">function</span>(<span class="params">word</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!colorMap[word]) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">return</span> makeUIColor(colorMap[word]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> colorMap = &#123;</span><br><span class="line">    <span class="string">"red"</span>: &#123;<span class="string">"red"</span>:<span class="number">255</span>, <span class="string">"green"</span>:<span class="number">0</span>, <span class="string">"blue"</span>: <span class="number">0</span>&#125;,</span><br><span class="line">    <span class="string">"green"</span>: &#123;<span class="string">"red"</span>:<span class="number">0</span>, <span class="string">"green"</span>:<span class="number">255</span>, <span class="string">"blue"</span>: <span class="number">0</span>&#125;,</span><br><span class="line">    <span class="string">"blue"</span>: &#123;<span class="string">"red"</span>:<span class="number">0</span>, <span class="string">"green"</span>:<span class="number">0</span>, <span class="string">"blue"</span>: <span class="number">255</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有一个叫<code>colorFromWord</code>的JS方法，它接收一个<code>word</code>参数，这个<code>colorMap</code>是一个JS对象，里面按颜色名字保存着一些色值信息，这些色值信息也是一个个的JS对象，这个<code>ColorFromWord</code>函数就是通过颜色名字来取得对应的颜色对象。然后这函数里面调用了<code>MakeUIColor</code>方法，并传入从<code>colorMap</code>中根据<code>word</code>字段取出来的颜色对象，注意这个颜色对象是一个JS对象，是一个<code>object</code>类型，但是我们传进来的Block接收的是一个<code>NSDIctionary</code>类型的参数啊，不用担心，这时JSCore会自动帮我们把JS对象类型转成<code>NSDictionary</code>类型，就像前面那个表里写的一样，<code>NSDictionary</code>对应着JS中的<code>Object</code>类型。</p>
<p>现在，我们有一个包装着Block的JS函数<code>makeUIColor</code>，然后又有一个<code>colorFromWrod</code>函数来调用它，具体过程就像这样：</p>
<p><img src="http://kailee.b0.upaiyun.com/colorfromwork2017.png" alt="img"></p>
<p>图从左边看起，<code>colorFromWrod</code>调用<code>makeUIColor</code>，传过去的参数是JS Object类型(从<code>colorMap</code>中取出的颜色对象)，JSCore会将这个传过来的<code>Object</code>参数转换成<code>NSDictionary</code>类型，然后<code>makeUIColor</code>用其去调用内部包装的Block，Block返回一个<code>UIColor(NSObject)</code>类型的返回值，JScore会将其转换成一个<code>wrapper Object</code>(其实也是JS <code>Object</code>类型)，返回给<code>colorFromWrod</code>。</p>
<h4 id="使用-Block-的坑"><a href="#使用-Block-的坑" class="headerlink" title="使用 Block 的坑"></a>使用 Block 的坑</h4><p>使用Block暴露方法很方便，但是有2个坑需要注意一下：</p>
<ul>
<li>不要在Block中直接使用JSValue</li>
<li>不要在Block中直接使用JSContext</li>
</ul>
<p>因为Block会强引用它里面用到的外部变量，如果直接在Block中使用JSValue的话，那么这个JSvalue就会被这个Block强引用，而每个JSValue都是强引用着它所属的那个JSContext的，这是前面说过的，而这个Block又是注入到这个Context中，所以这个Block会被context强引用，这样会造成循环引用，导致<strong>内存泄露</strong>。不能直接使用JSContext的原因同理。</p>
<p>那怎么办呢，针对第一点，建议把JSValue当做参数传到Block中，而不是直接在Block内部使用，这样Block就不会强引用JSValue了。</p>
<p>针对第二点，可以使用<code>[JSContext currentContext]</code>方法来获取当前的Context。</p>
<h4 id="JSExport-协议"><a href="#JSExport-协议" class="headerlink" title="JSExport 协议"></a>JSExport 协议</h4><h5 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h5><p>然后是JS和OC交互的第二种方式：<code>JSExport 协议</code>，通过JSExport 协议可以很方便的将OC中的对象暴露给JS使用，且在JS中用起来就和JS对象一样。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;JavaScriptCore/JavaScriptCore.h&gt;</span><br><span class="line">@class Car;</span><br><span class="line">@protocol CarExports &lt;JSExport, NSObject&gt;</span><br><span class="line"></span><br><span class="line">@property (nonatomic, copy) NSString *name;</span><br><span class="line">@property (nonatomic, copy) NSString *cID;</span><br><span class="line"></span><br><span class="line">- (NSString *)description;</span><br><span class="line"></span><br><span class="line">+ (MyPoint *)productCarWithName:(NSString *)carName</span><br><span class="line">                          carID:(NSString *)cID;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">需要注意的是，OC中的函数声明格式与JS中的不太一样（应该说和大部分语言都不一样。。），OC函数中多个参数是用冒号:声明的，这显然不能直接暴露给JS调用</span><br><span class="line"></span><br><span class="line">所以需要对带参数的方法名做一些调整，当我们暴露一个带参数的OC方法给JS时，JSCore会用以下两个规则生成一个对应的JS函数：</span><br><span class="line">1. 移除所有的冒号</span><br><span class="line">2. 将跟在冒号后面的第一个小写字母大写</span><br><span class="line"></span><br><span class="line">比如上面的那个类方法，转换之前方法名应该是 productCarWithName:carID:，在JS中生成的对应的方法名就会变成 productCarWithNameCarID。</span><br><span class="line"></span><br><span class="line">苹果知道这种不一致可能会逼死某些强迫症。。所以加了一个宏JSExportAs来处理这种情况，它的作用是：给JSCore在JS中为OC方法生成的对应方法指定名字。</span><br><span class="line"></span><br><span class="line">比如，还是上面这个方法productCarWithName:carID:，可以这样写：</span><br><span class="line">JSExportAs(productCar,</span><br><span class="line">+ (Car *)productCarWithName:(NSString *)carName carID:(NSString *)cID</span><br><span class="line">);</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>我们在Objective-C中有一个<code>Car</code>类，它有两个<code>NSString</code>类型的属性，<code>name</code> <code>cID</code>，一个实例方法<code>description</code> 和一个类方法 <code>productCarWithName:carID:</code></p>
<p>如果我们使用JSExport协议把这个类的对象暴露给JS，那么在JS中，我们怎么使用这个暴露过来的JS对象呢？他的属性可以直接调用，就像调用JS对象的属性一样，他的实例方法也可以直接调用，就像调用JS对象中的方法一样，然后他的类方法，也可以直接用某个全局对象直接调用。就像普通的JS一样，但是操作的却是一个OC对象。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">car.name</span><br><span class="line">car.name = <span class="string">'奔驰'</span></span><br><span class="line">car.description()</span><br><span class="line"></span><br><span class="line">Car.productCarWithNameCarID(<span class="string">'宝马'</span>,<span class="string">'20170727'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Car.productCar('宝马','20170727')</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：<strong>JSExportAs</strong> 这个宏只对<strong>带参数</strong>的OC方法有效。</p>
</blockquote>
<h3 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h3><p>我们都知道，Objective-C 用的是<code>ARC (Automatic Reference Counting)</code>，不能自动解决循环引用问题(<code>retain cycle</code>)，需要程序员手动处理，而JavaScript 用的是<code>GC (准确的说是 Tracing Garbage Collection)</code>，所有的引用都是强引用，但是垃圾回收器会帮我解决循环引用问题，JavaScriptCore 也一样，一般来说，大多数时候不需要我们去手动管理内存。</p>
<p>但是下面2种情况需要注意一下：</p>
<ul>
<li><p><strong>不要在JS中给OC对象增加成员变量</strong>，这句话的意思就是说，当我们将一个OC对象暴露给JS后，就像前面说的使用JSExport协议，我们能想操纵JS对象一样操纵OC对象，但是这时候，不要在JS中给这个OC对象添加成员变量，因为这个动作产生的后果就是，只会在JS中为这个OC对象增加一个额外的成员变量，但是OC中并不会同步增加。所以说这样做并没有什么意义，还有可能造成一些奇怪的内存管理问题。</p>
</li>
<li><p><strong>OC对象不要直接强引用JSValue对象</strong>，这句话再说直白点，就是不要直接将一个JSValue类型的对象当成属性或者成员变量保存在一个OC对象中，尤其是这个OC对象还暴露给JS的时候。这样会造成循环引用。</p>
</li>
</ul>
<p>如何解决这个问题呢？分析一下，在这里，我们需要一种弱的引用关系，因为强引用会造成循环引用，但是又不能让这个JSValue因无人引用它而被释放。简而言之就是，弱引用但能保持JSValue不被释放。</p>
<p>于是，苹果提供了一种新的引用关系，叫<code>conditional retain</code>，有条件的强引用，通过这种引用就能实现我们前面分析所需要的效果，而<code>JSManagedValue</code>就是苹果用来实现<code>conditional retain</code>的类。</p>
<p><img src="http://kailee.b0.upaiyun.com/jsmanagedvalueref2017.png" alt="img"></p>
<h4 id="JSManagedValue"><a href="#JSManagedValue" class="headerlink" title="JSManagedValue"></a>JSManagedValue</h4><p>这是JSManagedValue的一般使用步骤：</p>
<ul>
<li>首先，用JSValue创建一个JSManagedValue对象，JSManagedValue里面其实就是包着一个JSValue对象，可以通过它里面一个只读的value属性取到，这一步其实是添加一个对JSValue的弱引用。</li>
<li>如果只有第一步，这个JSValue会在其对应的JS值被垃圾回收器回收之后被释放，这样效果就和弱引用一样，所以还需要加一步，在虚拟机上为这个JSManagedValue对象添加Owner（这个虚拟机就是给JS执行提供资源的，待会再讲），这样做之后，就给JSValue增加一个强关系，只要以下两点有一点成立，这个JSManagedValue里面包含的JSValue就不会被释放：<ul>
<li>JSValue对应的JS值没有被垃圾回收器回收</li>
<li>Owner对象没有被释放</li>
</ul>
</li>
</ul>
<p>这样做，就即避免了循环引用，又保证了JSValue不会因为弱引用而被立刻释放。</p>
<h3 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h3><p>说多线程之前得先说下另一个类 <code>JSVirtualMachine</code>, 它为JavaScript的运行提供了底层资源，有自己独立的堆栈以及垃圾回收机制。</p>
<p><code>JSVirtualMachine</code>还是JSContext的容器，可以包含若干个JSContext，在一个进程中，你可以有多个<code>JSVirtualMachine</code>，里面包含着若干个JSContext，而JSContext中又有若干个JSValue。需要注意的是，你可以在同一个<code>JSVirtualMachine</code>的不同JSContext中，互相传递JSValue，但是不能再不同的<code>JSVirtualMachine</code>中的JSContext之间传递JSValue。这是因为，每个<code>JSVirtualMachine</code>都有自己独立的堆栈和垃圾回收器，一个<code>JSVirtualMachine</code>的垃圾回收器不知道怎么处理从另一个堆栈传过来的值。</p>
<p>说回多线程，JavaScriptCore提供的API本身就是线程安全的。</p>
<p>你可以在不同的线程中，创建JSValue，用JSContext执行JS语句，但是当一个线程正在执行JS语句时，其他线程想要使用这个正在执行JS语句的JSContext所属的<code>JSVirtualMachine</code>就必须得等待，等待前前一个线程执行完，才能使用这个<code>JSVirtualMachine</code>。</p>
<p>当然，这个强制串行的粒度是<code>JSVirtualMachine</code>，如果你想要在不用线程中并发执行JS代码，可以为不同的线程创建不同<code>JSVirtualMachine</code>。</p>
<hr>
<hr>
<h2 id="基于-UIWebView-WKWebView-原生控件实现-jsoc"><a href="#基于-UIWebView-WKWebView-原生控件实现-jsoc" class="headerlink" title="基于 UIWebView/WKWebView 原生控件实现 jsoc"></a>基于 UIWebView/WKWebView 原生控件实现 js<->oc</-></h2><h3 id="Native-直接调用-js"><a href="#Native-直接调用-js" class="headerlink" title="Native 直接调用 js"></a>Native 直接调用 js</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (nullable NSString *)stringByEvaluatingJavaScriptFromString:(NSString *)script;</span><br><span class="line"></span><br><span class="line">- (void)evaluateJavaScript:(NSString *)javaScriptString completionHandler:(void (^ __nullable)(__nullable id, NSError * __nullable error))completionHandler;//WKWebView使用，以下类推)</span><br></pre></td></tr></table></figure>
<h3 id="js-间接调用-Native-的方式："><a href="#js-间接调用-Native-的方式：" class="headerlink" title="js 间接调用 Native 的方式："></a>js 间接调用 Native 的方式：</h3><h4 id="UIWebView"><a href="#UIWebView" class="headerlink" title="UIWebView"></a>UIWebView</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (BOOL)webView:(UIWebView *)webView shouldStartLoadWithRequest:(NSURLRequest *)request navigationType:(UIWebViewNavigationType)navigationType;</span><br></pre></td></tr></table></figure>
<p>这个方法，可以每次在UIWebView进行<strong>重定向URL</strong>的时候，进行触发，只要把一个js调用native的方法包装成一个重定向URL,就可以在本地接收到相应的方法。</p>
<h4 id="WKWebView"><a href="#WKWebView" class="headerlink" title="WKWebView"></a>WKWebView</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (void)webView:(WKWebView *)webView decidePolicyForNavigationAction:(WKNavigationAction *)navigationAction decisionHandler:(void (^)(WKNavigationActionPolicy))decisionHandler;</span><br></pre></td></tr></table></figure>
<p><strong>小结：native可以直接调用js，js将方法包装成重定向请求，使得native截取并分析，执行相应代码。</strong></p>
<hr>
<hr>
<h2 id="JavaScriptCore-和-UIWebView-的结合使用"><a href="#JavaScriptCore-和-UIWebView-的结合使用" class="headerlink" title="JavaScriptCore 和 UIWebView 的结合使用"></a>JavaScriptCore 和 UIWebView 的结合使用</h2><p>通过上面的demo，应该差不多了解OC如何和JS进行通信。下面我们看看如何对 <code>UIWebView</code> 进行操作，我们不再通过URL拦截，我们直接取 <code>UIWebView</code> 的 <code>context</code>，然后进行对JS操作。</p>
<p>在<code>UIWebView</code>的finish的回调中进行获取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (void)webViewDidFinishLoad:(UIWebView *)webView</span><br><span class="line">&#123;</span><br><span class="line">    self.context = [webView valueForKeyPath:@&quot;documentView.webView.mainFrame.javaScriptContext&quot;];</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面用了私有属性，可能会被苹果给拒了。这边要注意的是每个页面加载完都是一个新的<code>context</code>，但是都是同一个<code>JSVirtualMachine</code>。如果JS调用OC方法进行操作UI的时候，请注意线程是不是主线程。具体可以参考<a href="https://segmentfault.com/a/1190000004285316" target="_blank" rel="noopener">iOS引入JavaScriptCore引擎框架</a>这篇文章。</p>
<h2 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h2><p>文章有点儿长了，文中有不同程度的引用，在参考文献表明。欢迎邮件联系，指正！！！</p>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ul>
<li><a href="https://nshipster.com/javascriptcore/" target="_blank" rel="noopener">JavaScriptCore</a></li>
<li><a href="https://link.jianshu.com/?t=https://developer.apple.com/reference/javascriptcore?language=objc" target="_blank" rel="noopener">JavaScriptCore API Reference</a></li>
<li><a href="https://www.jianshu.com/p/ac534f508fb0" target="_blank" rel="noopener">深入浅出 JavaScriptCore</a></li>
<li><a href="https://segmentfault.com/a/1190000004285316" target="_blank" rel="noopener">iOS引入JavaScriptCore引擎框架</a></li>
<li><a href="https://www.jianshu.com/p/ac45d99cf912" target="_blank" rel="noopener">iOS中UIWebView与WKWebView、JavaScript与OC交互、Cookie管理看我就够（上）</a></li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/oc/" rel="tag"># oc</a>
          
            <a href="/tags/javascript/" rel="tag"># javascript</a>
          
            <a href="/tags/webview/" rel="tag"># webview</a>
          
            <a href="/tags/JSBridge/" rel="tag"># JSBridge</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/06/11/2017-6-11-伪WEEX实践篇/" rel="next" title="伪WEEX实践篇">
                <i class="fa fa-chevron-left"></i> 伪WEEX实践篇
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/08/05/2017-8-5-iOS集成ijkplayer播放视频/" rel="prev" title="iOS集成ijkplayer播放视频">
                iOS集成ijkplayer播放视频 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="karl">
            
              <p class="site-author-name" itemprop="name">karl</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">98</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">21</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">84</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/likenow" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:fmslikai@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://yujiangshui.com/" title="yujiangshui" target="_blank">yujiangshui</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#基于-JavaScriptCore-框架-实现-jsoc"><span class="nav-number">2.</span> <span class="nav-text">基于 JavaScriptCore 框架 实现 jsoc</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#简介"><span class="nav-number">2.1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#oc-与-javascript-交互"><span class="nav-number">2.2.</span> <span class="nav-text">oc 与 javascript 交互</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#JSContext"><span class="nav-number">2.2.1.</span> <span class="nav-text">JSContext</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JSValue"><span class="nav-number">2.2.2.</span> <span class="nav-text">JSValue</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实际使用"><span class="nav-number">2.2.3.</span> <span class="nav-text">实际使用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#javascript-与-oc-交互"><span class="nav-number">2.3.</span> <span class="nav-text">javascript 与 oc 交互</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Block"><span class="nav-number">2.3.1.</span> <span class="nav-text">Block</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用-Block-的坑"><span class="nav-number">2.3.2.</span> <span class="nav-text">使用 Block 的坑</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JSExport-协议"><span class="nav-number">2.3.3.</span> <span class="nav-text">JSExport 协议</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#介绍"><span class="nav-number">2.3.3.1.</span> <span class="nav-text">介绍</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#内存管理"><span class="nav-number">2.4.</span> <span class="nav-text">内存管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#JSManagedValue"><span class="nav-number">2.4.1.</span> <span class="nav-text">JSManagedValue</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#多线程"><span class="nav-number">2.5.</span> <span class="nav-text">多线程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#基于-UIWebView-WKWebView-原生控件实现-jsoc"><span class="nav-number">3.</span> <span class="nav-text">基于 UIWebView/WKWebView 原生控件实现 jsoc</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Native-直接调用-js"><span class="nav-number">3.1.</span> <span class="nav-text">Native 直接调用 js</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#js-间接调用-Native-的方式："><span class="nav-number">3.2.</span> <span class="nav-text">js 间接调用 Native 的方式：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#UIWebView"><span class="nav-number">3.2.1.</span> <span class="nav-text">UIWebView</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#WKWebView"><span class="nav-number">3.2.2.</span> <span class="nav-text">WKWebView</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JavaScriptCore-和-UIWebView-的结合使用"><span class="nav-number">4.</span> <span class="nav-text">JavaScriptCore 和 UIWebView 的结合使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#结尾"><span class="nav-number">5.</span> <span class="nav-text">结尾</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考文献"><span class="nav-number">6.</span> <span class="nav-text">参考文献</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2013 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">karl</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
